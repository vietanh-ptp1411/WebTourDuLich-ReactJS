{"version":3,"sources":["../../src/vnpay/VNPay.js"],"names":["VNPay","constructor","config","Object","assign","configSchema","validate","buildCheckoutUrl","payload","Promise","resolve","reject","data","checkoutPayloadDefaults","vnpSecretKey","secureSecret","vnpMerchant","merchant","validateCheckoutPayload","error","message","amount","Math","floor","arrParam","vnp_Version","vnpVersion","vnp_Command","vnpCommand","vnp_TmnCode","vnp_Locale","locale","vnp_BankCode","bankCode","vnp_CurrCode","currency","vnp_TxnRef","orderId","vnp_OrderInfo","orderInfo","vnp_OrderType","orderType","vnp_Amount","String","vnp_ReturnUrl","returnUrl","vnp_IpAddr","clientIp","vnp_CreateDate","createdDate","Date","redirectUrl","URL","paymentGateway","secureCode","keys","sort","forEach","key","value","length","searchParams","append","substr","push","join","checkoutSchema","CURRENCY_VND","LOCALE_VN","VERSION","COMMAND","verifyReturnUrl","query","returnObject","_mapQueryToObject","vnpTxnSecureHash","vnp_SecureHash","verifyResults","vnp_SecureHashType","isSuccess","responseCode","transactionId","parseInt","vnp_ResponseCode","bankTranNo","vnp_BankTranNo","cardType","vnp_CardType","payDate","vnp_PayDate","gatewayTransactionNo","vnp_TransactionNo","secureHash","getReturnUrlStatus","responseCodeTable","vn","en","default","respondText","SimpleSchema","type","optional","Integer","max","allowedValues","billingCity","billingCountry","billingPostCode","billingStateProvince","billingStreet","customerEmail","regEx","RegEx","Email","customerId","customerPhone","deliveryAddress","deliveryCity","deliveryCountry","deliveryProvince","Url","LOCALE_EN","TEST_CONFIG"],"mappings":"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","file":"VNPay.js","sourcesContent":["/* © 2018 NauStud.io\n * @author Eric Tran\n */\n\nimport SimpleSchema from 'simpl-schema';\nimport { URL } from 'url';\nimport { vnPayDateFormat, createMd5Hash, toUpperCase } from '../utils';\n\n/**\n * VNPay payment gateway helper\n * <br>\n * _Hàm hỗ trợ thanh toán qua VNPay_\n *\n * @example\n * import { VNPay } from 'vn-payments';\n *\n * const TEST_CONFIG = VNPay.TEST_CONFIG;\n *\n * const vnpayCheckout = new VNPay({\n * \tpaymentGateway: TEST_CONFIG.paymentGateway,\n * \tmerchant: TEST_CONFIG.merchant,\n * \tsecureSecret: TEST_CONFIG.secureSecret,\n * });\n *\n * // checkoutUrl is an URL instance\n * const checkoutUrl = await vnpayCheckout.buildCheckoutUrl(params);\n *\n * this.response.writeHead(301, { Location: checkoutUrl.href });\n * this.response.end();\n */\nclass VNPay {\n\t/**\n\t * Instantiate a VNPay checkout helper\n\t * <br>\n\t * _Khởi tạo hàm thanh toán VNPay_\n\t * @param  {Object} config check VNPay.configSchema for data type requirements <br> _Xem VNPay.configSchema để biết yêu cầu kiểu dữ liệu_\n\t * @return {void}\n\t */\n\tconstructor(config) {\n\t\tthis.config = Object.assign({}, config);\n\t\t// check type validity\n\t\tVNPay.configSchema.validate(this.config);\n\t}\n\n\t/**\n\t * Build checkoutUrl to redirect to the payment gateway\n\t * <br>\n\t * _Hàm xây dựng url để redirect qua VNPay gateway, trong đó có tham số mã hóa (còn gọi là public key)_\n\t *\n\t * @param  {VNPayCheckoutPayload} payload Object that contains needed data for the URL builder, refer to typeCheck object above <br> _Đối tượng chứa các dữ liệu cần thiết để thiết lập đường dẫn._\n\t * @return {Promise<URL>} buildCheckoutUrl promise\n\t */\n\tbuildCheckoutUrl(payload) {\n\t\treturn new Promise((resolve, reject) => {\n\t\t\t// Mảng các tham số chuyển tới VNPay Payment\n\t\t\tconst data = Object.assign({}, this.checkoutPayloadDefaults, payload);\n\t\t\tconst config = this.config;\n\n\t\t\tdata.vnpSecretKey = config.secureSecret;\n\t\t\tdata.vnpMerchant = config.merchant;\n\n\t\t\t// Input type checking\n\t\t\ttry {\n\t\t\t\tthis.validateCheckoutPayload(data);\n\t\t\t} catch (error) {\n\t\t\t\treject(error.message);\n\t\t\t}\n\n\t\t\t// convert amount to VNPay format (100 = 1VND):\n\t\t\tdata.amount = Math.floor(data.amount * 100);\n\n\t\t\t/* prettier-ignore */\n\t\t\tconst arrParam = {\n\t\t\t\tvnp_Version        : data.vnpVersion,\n\t\t\t\tvnp_Command        : data.vnpCommand,\n\t\t\t\tvnp_TmnCode        : data.vnpMerchant,\n\t\t\t\tvnp_Locale         : data.locale,\n\t\t\t\tvnp_BankCode       : data.bankCode,\n\t\t\t\tvnp_CurrCode       : data.currency,\n\t\t\t\tvnp_TxnRef         : data.orderId,\n\t\t\t\tvnp_OrderInfo      : data.orderInfo,\n\t\t\t\tvnp_OrderType      : data.orderType,\n\t\t\t\tvnp_Amount         : String(data.amount),\n\t\t\t\tvnp_ReturnUrl      : data.returnUrl,\n\t\t\t\tvnp_IpAddr         : data.clientIp,\n\t\t\t\tvnp_CreateDate     : data.createdDate || vnPayDateFormat(new Date()),\n\t\t\t};\n\n\t\t\t// Step 2. Create the target redirect URL at VNPay server\n\t\t\tconst redirectUrl = new URL(config.paymentGateway);\n\t\t\tconst secureCode = [];\n\n\t\t\tObject.keys(arrParam)\n\t\t\t\t.sort()\n\t\t\t\t.forEach(key => {\n\t\t\t\t\tconst value = arrParam[key];\n\n\t\t\t\t\tif (value == null || value.length === 0) {\n\t\t\t\t\t\t// skip empty params (but they must be optional)\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\tredirectUrl.searchParams.append(key, value); // no need to encode URI with URLSearchParams object\n\n\t\t\t\t\tif (value.length > 0 && (key.substr(0, 4) === 'vnp_' || key.substr(0, 5) === 'user_')) {\n\t\t\t\t\t\t// secureCode is digested from vnp_* params but they should not be URI encoded\n\t\t\t\t\t\tsecureCode.push(`${key}=${value}`);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\t/* Step 3. calculate the param checksum with md5*/\n\n\t\t\tif (secureCode.length > 0) {\n\t\t\t\tredirectUrl.searchParams.append('vnp_SecureHashType', 'MD5');\n\t\t\t\tredirectUrl.searchParams.append('vnp_SecureHash', createMd5Hash(data.vnpSecretKey + secureCode.join('&')));\n\t\t\t}\n\n\t\t\tresolve(redirectUrl);\n\t\t});\n\t}\n\n\t/**\n\t * Validate checkout payload against specific schema. Throw ValidationErrors if invalid against checkoutSchema\n\t * <br>\n\t * _Kiểm tra tính hợp lệ của dữ liệu thanh toán dựa trên một cấu trúc dữ liệu cụ thể. Hiển thị lỗi nếu không hợp lệ với checkoutSchema._\n\t *\n\t * @param {VNPayCheckoutPayload} payload\n\t */\n\tvalidateCheckoutPayload(payload) {\n\t\tVNPay.checkoutSchema.validate(payload);\n\t}\n\n\t/**\n\t * Return default checkout Payloads\n\t *\n\t * _Lấy checkout payload mặc định cho cổng thanh toán này_\n\t * @return {VNPayCheckoutPayload} default payload object <br> _Dữ liệu mặc định của đối tượng_\n\t */\n\tget checkoutPayloadDefaults() {\n\t\t/* prettier-ignore */\n\t\treturn {\n\t\t\tcurrency             : VNPay.CURRENCY_VND,\n\t\t\tlocale               : VNPay.LOCALE_VN,\n\t\t\tvnpVersion           : VNPay.VERSION,\n\t\t\tvnpCommand \t\t\t : VNPay.COMMAND,\n\t\t};\n\t}\n\n\t/**\n\t * @typedef {Object} VNPayReturnObject\n\t * @property {boolean} isSuccess whether the payment succeeded or not\n\t * @property {string} message Approve or error message based on response code\n\t * @property {string} merchant merchant ID, should be same with checkout request\n\t * @property {string} transactionId merchant's transaction ID, should be same with checkout request\n\t * @property {number} amount amount paid by customer, already divided by 100\n\t * @property {string} orderInfo order info, should be same with checkout request\n\t * @property {string} responseCode response code, payment has errors if it is non-zero\n\t * @property {string} bankCode bank code of the bank where payment was occurred\n\t * @property {string} bankTranNo bank transaction ID, used to look up at Bank's side\n\t * @property {string} cardType type of card\n\t * @property {string} payDate date when transaction occurred\n\t * @property {string} gatewayTransactionNo Gateway's own transaction ID, used to look up at Gateway's side\n\t * @property {string} secureHash checksum of the returned data, used to verify data integrity\n\t *\n\t * @property {string} vnp_TmnCode e.g: COCOSIN\n\t * @property {string} vnp_TxnRef e.g: node-2018-01-15T10:04:36.540Z\n\t * @property {string} vnp_Amount e.g: 90000000\n\t * @property {string} vnp_OrderInfo e.g: Thanh toan giay adidas\n\t * @property {string} vnp_ResponseCode e.g: 00\n\t * @property {string} vnp_BankCode e.g: NCB\n\t * @property {string} vnp_BankTranNo e.g: 20180115170515\n\t * @property {string} vnp_CardType e.g: ATM\n\t * @property {string} vnp_PayDate e.g: 20180115170716\n\t * @property {string} vnp_TransactionNo e.g: 13008888\n\t * @property {string} vnp_SecureHash e.g: 115ad37de7ae4d28eb819ca3d3d85b20\n\t */\n\t/**\n\t * Verify return query string from VNPay using enclosed vnp_SecureHash string\n\t * <br>\n\t * _Hàm thực hiện xác minh tính đúng đắn của các tham số trả về từ vnpay Payment_\n\t *\n\t * @param  {Object} query Query data object from GET handler (`response.query`) <br> _Dữ liệu được trả về từ GET handler (`response.query`)_\n\t * @return {Promise<VNPayReturnObject>}  Promise object which resolved with normalized returned data object, with additional fields like isSuccess. <br> _Promise khi hoàn thành sẽ trả về object data từ cổng thanh toán, được chuẩn hóa tên theo camelCase và đính kèm thuộc tính isSuccess_\n\t */\n\tverifyReturnUrl(query) {\n\t\treturn new Promise(resolve => {\n\t\t\tconst returnObject = this._mapQueryToObject(query);\n\n\t\t\tconst data = Object.assign({}, query);\n\t\t\tconst config = this.config;\n\t\t\tconst vnpTxnSecureHash = data.vnp_SecureHash;\n\t\t\tconst verifyResults = {};\n\t\t\tdelete data.vnp_SecureHashType;\n\t\t\tdelete data.vnp_SecureHash;\n\n\t\t\tif (config.secureSecret.length > 0) {\n\t\t\t\tconst secureCode = [];\n\n\t\t\t\tObject.keys(data)\n\t\t\t\t\t.sort() // need to sort the key by alphabetically\n\t\t\t\t\t.forEach(key => {\n\t\t\t\t\t\tconst value = data[key];\n\n\t\t\t\t\t\tif (value.length > 0 && (key.substr(0, 4) === 'vnp_' || key.substr(0, 5) === 'user_')) {\n\t\t\t\t\t\t\tsecureCode.push(`${key}=${value}`);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\n\t\t\t\tif (toUpperCase(vnpTxnSecureHash) === toUpperCase(createMd5Hash(config.secureSecret + secureCode.join('&')))) {\n\t\t\t\t\tverifyResults.isSuccess = returnObject.responseCode === '00';\n\t\t\t\t} else {\n\t\t\t\t\tverifyResults.isSuccess = false;\n\t\t\t\t\tverifyResults.message = 'Wrong checksum';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tresolve(Object.assign(returnObject, query, verifyResults));\n\t\t});\n\t}\n\n\t_mapQueryToObject(query) {\n\t\tconst returnObject = {\n\t\t\tmerchant: query.vnp_TmnCode,\n\t\t\ttransactionId: query.vnp_TxnRef,\n\t\t\tamount: parseInt(query.vnp_Amount, 10) / 100,\n\t\t\torderInfo: query.vnp_OrderInfo,\n\t\t\tresponseCode: query.vnp_ResponseCode,\n\t\t\tbankCode: query.vnp_BankCode,\n\t\t\tbankTranNo: query.vnp_BankTranNo,\n\t\t\tcardType: query.vnp_CardType,\n\t\t\tpayDate: query.vnp_PayDate,\n\t\t\tgatewayTransactionNo: query.vnp_TransactionNo,\n\t\t\tsecureHash: query.vnp_SecureHash,\n\t\t\tmessage: VNPay.getReturnUrlStatus(query.vnp_ResponseCode), // no message from gateway, we'll look it up on our side\n\t\t};\n\n\t\treturn returnObject;\n\t}\n\n\t/**\n\t * Get known response code status\n\t * <br>\n\t * _Lấy chuỗi trạng thái từ response code đã biết_\n\t * @param {*} responseCode Responde code from gateway <br> _Mã trả về từ cổng thanh toán_\n\t * @param {*} locale Same locale at the buildCheckoutUrl. Note, 'vn' for Vietnamese <br> _Cùng nơi với hàm buildCheckoutUrl. Lưu ý, 'vn' là Việt Nam_\n\t *  @return {string}  A string contains error status converted from response code <br> _Một chuỗi chứa trạng thái lỗi được chuyển lại từ response code_\n\t */\n\tstatic getReturnUrlStatus(responseCode, locale = 'vn') {\n\t\tconst responseCodeTable = {\n\t\t\t'00': {\n\t\t\t\tvn: 'Giao dịch thành công',\n\t\t\t\ten: 'Approved',\n\t\t\t},\n\t\t\t'01': {\n\t\t\t\tvn: 'Giao dịch đã tồn tại',\n\t\t\t\ten: 'Transaction is already exist',\n\t\t\t},\n\t\t\t'02': {\n\t\t\t\tvn: 'Merchant không hợp lệ (kiểm tra lại vnp_TmnCode)',\n\t\t\t\ten: 'Invalid merchant (check vnp_TmnCode value)',\n\t\t\t},\n\t\t\t'03': {\n\t\t\t\tvn: 'Dữ liệu gửi sang không đúng định dạng',\n\t\t\t\ten: 'Sent data is not in the right format',\n\t\t\t},\n\t\t\t'04': {\n\t\t\t\tvn: 'Khởi tạo GD không thành công do Website đang bị tạm khóa',\n\t\t\t\ten: 'Payment website is not available',\n\t\t\t},\n\t\t\t'05': {\n\t\t\t\tvn:\n\t\t\t\t\t'Giao dịch không thành công do: Quý khách nhập sai mật khẩu thanh toán quá số lần quy định. Xin quý khách vui lòng thực hiện lại giao dịch',\n\t\t\t\ten: 'Transaction failed: Too many wrong password input',\n\t\t\t},\n\t\t\t'06': {\n\t\t\t\tvn:\n\t\t\t\t\t'Giao dịch không thành công do Quý khách nhập sai mật khẩu xác thực giao dịch (OTP). Xin quý khách vui lòng thực hiện lại giao dịch.',\n\t\t\t\ten: 'Transaction failed: Wrong OTP input',\n\t\t\t},\n\t\t\t'07': {\n\t\t\t\tvn:\n\t\t\t\t\t'Trừ tiền thành công. Giao dịch bị nghi ngờ (liên quan tới lừa đảo, giao dịch bất thường). Đối với giao dịch này cần merchant xác nhận thông qua merchant admin: Từ chối/Đồng ý giao dịch',\n\t\t\t\ten: 'This transaction is suspicious',\n\t\t\t},\n\t\t\t'08': {\n\t\t\t\tvn:\n\t\t\t\t\t'Giao dịch không thành công do: Hệ thống Ngân hàng đang bảo trì. Xin quý khách tạm thời không thực hiện giao dịch bằng thẻ/tài khoản của Ngân hàng này.',\n\t\t\t\ten:\n\t\t\t\t\t'Transaction failed: The banking system is under maintenance. Please do not temporarily make transactions by card / account of this Bank.',\n\t\t\t},\n\t\t\t'09': {\n\t\t\t\tvn:\n\t\t\t\t\t'Giao dịch không thành công do: Thẻ/Tài khoản của khách hàng chưa đăng ký dịch vụ InternetBanking tại ngân hàng.',\n\t\t\t\ten: 'Transaction failed: Cards / accounts of customer who has not yet registered for Internet Banking service.',\n\t\t\t},\n\t\t\t10: {\n\t\t\t\tvn: 'Giao dịch không thành công do: Khách hàng xác thực thông tin thẻ/tài khoản không đúng quá 3 lần',\n\t\t\t\ten: 'Transaction failed: Customer incorrectly validate the card / account information more than 3 times',\n\t\t\t},\n\t\t\t11: {\n\t\t\t\tvn: 'Giao dịch không thành công do: Đã hết hạn chờ thanh toán. Xin quý khách vui lòng thực hiện lại giao dịch.',\n\t\t\t\ten: 'Transaction failed: Pending payment is expired. Please try again.',\n\t\t\t},\n\t\t\t24: {\n\t\t\t\tvn: 'Giao dịch không thành công do: Khách hàng hủy giao dịch',\n\t\t\t\ten: 'Transaction canceled',\n\t\t\t},\n\t\t\t51: {\n\t\t\t\tvn: 'Giao dịch không thành công do: Tài khoản của quý khách không đủ số dư để thực hiện giao dịch.',\n\t\t\t\ten: 'Transaction failed: Your account is not enough balance to make the transaction.',\n\t\t\t},\n\t\t\t65: {\n\t\t\t\tvn: 'Giao dịch không thành công do: Tài khoản của Quý khách đã vượt quá hạn mức giao dịch trong ngày.',\n\t\t\t\ten: 'Transaction failed: Your account has exceeded the daily limit.',\n\t\t\t},\n\t\t\t75: {\n\t\t\t\tvn: 'Ngân hàng thanh toán đang bảo trì',\n\t\t\t\ten: 'Banking system is under maintenance',\n\t\t\t},\n\t\t\tdefault: {\n\t\t\t\tvn: 'Giao dịch thất bại',\n\t\t\t\ten: 'Failured',\n\t\t\t},\n\t\t};\n\n\t\tconst respondText = responseCodeTable[responseCode];\n\n\t\treturn respondText ? respondText[locale] : responseCodeTable.default[locale];\n\t}\n}\n\n/**\n * @typedef {Object} VNPayCheckoutPayload\n * @property {string} createdDate  optional: true\n * @property {number} amount The pay amount, Integer, max: 9999999999\n * @property {string} clientIp  max: 16\n * @property {string} currency  allowedValues: ['VND']\n * @property {string} billingCity  optional: true, max: 255\n * @property {string} billingCountry  optional: true, max: 255\n * @property {string} billingPostCode  optional: true, max: 255\n * @property {string} billingStateProvince  optional: true, max: 255\n * @property {string} billingStreet  optional: true, max: 255\n * @property {string} customerEmail  optional: true, max: 255, regEx: SimpleSchema.RegEx.Email\n * @property {string} customerId  optional: true, max: 255\n * @property {string} customerPhone  optional: true, max: 255\n * @property {string} deliveryAddress  optional: true, max: 255\n * @property {string} deliveryCity  optional: true, max: 255\n * @property {string} deliveryCountry  optional: true, max: 255\n * @property {string} deliveryProvince  optional: true, max: 255\n * @property {string} bankCode  optional: true, max: 50\n * @property {string} locale  allowedValues: ['vn', 'en']\n * @property {string} orderId  max: 34\n * @property {string} orderInfo  max: 255\n * @property {string} orderType  max: 40\n * @property {string} returnUrl  max: 255\n * @property {string} transactionId  max: 40\n * @property {string} vnpSecretKey  max: 32\n * @property {string} vnpMerchant  max: 16\n * @property {string} vnpCommand  max: 16\n * @property {string} vnpVersion  max: 2\n * @property {string} paymentGateway  regEx: SimpleSchema.RegEx.Url\n * @property {string} merchant\n * @property {string} secureSecret\n */\n\n/* prettier-ignore */\n/**\n * The schema is based on field data requirements from VNPay's dev document\n * <br>\n * _Cấu trúc dữ liệu được dựa trên các yêu cầu của tài liệu VNPay_\n * @type {SimpleSchema}\n */\nVNPay.checkoutSchema = new SimpleSchema({\n\tcreatedDate \t\t : { type: String, optional: true },\n\tamount               : { type: SimpleSchema.Integer, max: 9999999999 },\n\tclientIp             : { type: String, max: 16 },\n\tcurrency             : { type: String, allowedValues: ['VND'] },\n\tbillingCity          : { type: String, optional: true, max: 255 }, // NOTE: no max limit documented for optional fields, this is just a safe value\n\tbillingCountry       : { type: String, optional: true, max: 255 },\n\tbillingPostCode      : { type: String, optional: true, max: 255 },\n\tbillingStateProvince : { type: String, optional: true, max: 255 },\n\tbillingStreet        : { type: String, optional: true, max: 255 },\n\tcustomerEmail        : { type: String, optional: true, max: 255, regEx: SimpleSchema.RegEx.Email },\n\tcustomerId           : { type: String, optional: true, max: 255 },\n\tcustomerPhone        : { type: String, optional: true, max: 255 },\n\tdeliveryAddress      : { type: String, optional: true, max: 255 },\n\tdeliveryCity         : { type: String, optional: true, max: 255 },\n\tdeliveryCountry      : { type: String, optional: true, max: 255 },\n\tdeliveryProvince     : { type: String, optional: true, max: 255 },\n\tbankCode             : { type: String, optional: true, max: 50 },\n\tlocale               : { type: String, allowedValues: ['vn', 'en'] },\n\torderId              : { type: String, max: 34 },\n\torderInfo            : { type: String, max: 255 },\n\torderType            : { type: String, max: 40 },\n\treturnUrl            : { type: String, max: 255 },\n\ttransactionId        : { type: String, max: 40 },\n\tvnpSecretKey         : { type: String, max: 32 },\n\tvnpMerchant          : { type: String, max: 16 },\n\tvnpCommand           : { type: String, max: 16 },\n\tvnpVersion           : { type: String, max: 2 },\n});\n\n/**\n * VNPay configSchema\n * @type {SimpleSchema}\n */\nVNPay.configSchema = new SimpleSchema({\n\tpaymentGateway: { type: String, regEx: SimpleSchema.RegEx.Url },\n\tmerchant: { type: String },\n\tsecureSecret: { type: String },\n});\n// should not be changed\nVNPay.VERSION = '2';\nVNPay.COMMAND = 'pay';\n// vnpay only support VND\nVNPay.CURRENCY_VND = 'VND';\nVNPay.LOCALE_EN = 'en';\nVNPay.LOCALE_VN = 'vn';\n\nVNPay.TEST_CONFIG = {\n\tpaymentGateway: 'http://sandbox.vnpayment.vn/paymentv2/vpcpay.html',\n\tmerchant: 'COCOSIN',\n\tsecureSecret: 'RAOEXHYVSDDIIENYWSLDIIZTANXUXZFJ',\n};\n\nexport { VNPay };\n"]}